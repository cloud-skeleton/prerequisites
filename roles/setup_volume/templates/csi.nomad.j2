job "csi-plugin" {
    namespace = "system"
    type      = "system"

    constraint {
        attribute = "${node.class}"
        operator  = "="
        value     = "main-worker"
    }

    group "rocketduck/csi-plugin-nfs" {
        task "plugin" {
            driver = "docker"

            config {
                args = [
                    "--node-id=${attr.unique.hostname}",
                    "--type=monolith",
                    "--log-level={{ csi_plugin_log_level }}",
                    "--nfs-server={{ nomad_cluster_volume_nfs_share }}",
                    "--mount-options=defaults,vers=4,nconnect=16,lookupcache=positive,noatime",
                    "--allow-nested-volumes"
                ]
                cpu_hard_limit = true
                image          = "registry.gitlab.com/rocketduck/csi-plugin-nfs:{{ csi_plugin_version }}"
                network_mode   = "host"
                privileged     = true
            }

            csi_plugin {
                health_timeout = "2m"
                id             = "csi.cloudskeleton.eu"
                type           = "monolith"
            }

            resources {
                cpu    = 50
                memory = 32
            }
        }
    }
}